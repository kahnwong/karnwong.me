<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Secrets management with SOPS, AWS SSM and Terraform | Karn Wong</title><meta name=keywords content="devops,aws,github,terraform"><meta name=description content="At my organization we use sops to check in encrypted secrets into git repos. This solves plaintext credentials in version control. However, say, you have 5 repos using the same database credentials, rotating secrets means you have to go into each repo and update the SOPS credentials manually.
Also worth nothing that, for GitHub actions, authenticating AWS means you have to add repo secrets. This means for all the repos you have CI enabled, you have to populate the repo secrets with AWS credentials."><meta name=author content="Karn Wong"><link rel=canonical href=https://www.karnwong.me/posts/2021/11/secrets-management-with-sops-aws-ssm-terraform/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.karnwong.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.karnwong.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.karnwong.me/favicon-32x32.png><link rel=apple-touch-icon href=https://www.karnwong.me/apple-touch-icon.png><link rel=mask-icon href=https://www.karnwong.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-8CYMFC0KZ9"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8CYMFC0KZ9",{anonymize_ip:!1})}</script><meta property="og:title" content="Secrets management with SOPS, AWS SSM and Terraform"><meta property="og:description" content="At my organization we use sops to check in encrypted secrets into git repos. This solves plaintext credentials in version control. However, say, you have 5 repos using the same database credentials, rotating secrets means you have to go into each repo and update the SOPS credentials manually.
Also worth nothing that, for GitHub actions, authenticating AWS means you have to add repo secrets. This means for all the repos you have CI enabled, you have to populate the repo secrets with AWS credentials."><meta property="og:type" content="article"><meta property="og:url" content="https://www.karnwong.me/posts/2021/11/secrets-management-with-sops-aws-ssm-terraform/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-30T20:11:12+07:00"><meta property="article:modified_time" content="2021-11-30T20:11:12+07:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Secrets management with SOPS, AWS SSM and Terraform"><meta name=twitter:description content="At my organization we use sops to check in encrypted secrets into git repos. This solves plaintext credentials in version control. However, say, you have 5 repos using the same database credentials, rotating secrets means you have to go into each repo and update the SOPS credentials manually.
Also worth nothing that, for GitHub actions, authenticating AWS means you have to add repo secrets. This means for all the repos you have CI enabled, you have to populate the repo secrets with AWS credentials."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.karnwong.me/posts/"},{"@type":"ListItem","position":2,"name":"Secrets management with SOPS, AWS SSM and Terraform","item":"https://www.karnwong.me/posts/2021/11/secrets-management-with-sops-aws-ssm-terraform/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Secrets management with SOPS, AWS SSM and Terraform","name":"Secrets management with SOPS, AWS SSM and Terraform","description":"At my organization we use sops to check in encrypted secrets into git repos. This solves plaintext credentials in version control. However, say, you have 5 repos using the same database credentials, rotating secrets means you have to go into each repo and update the SOPS credentials manually.\nAlso worth nothing that, for GitHub actions, authenticating AWS means you have to add repo secrets. This means for all the repos you have CI enabled, you have to populate the repo secrets with AWS credentials.","keywords":["devops","aws","github","terraform"],"articleBody":"At my organization we use sops to check in encrypted secrets into git repos. This solves plaintext credentials in version control. However, say, you have 5 repos using the same database credentials, rotating secrets means you have to go into each repo and update the SOPS credentials manually.\nAlso worth nothing that, for GitHub actions, authenticating AWS means you have to add repo secrets. This means for all the repos you have CI enabled, you have to populate the repo secrets with AWS credentials. When time comes for rotating the creds, you’ll encounter the same situation as above.\nI did some research and consensus for AWS / Terraform setup is to: encrypt secrets via SOPS, and use Terraform to create AWS SSM secret entries. That way, you have a trail for credentials. This setup means:\nYou don’t have to populate repos with AWS creds, instead supplying an ARN role instead. You don’t have to change credentials in projects, since they all get the secrets from AWS SSM. Implementation Repo here: https://github.com/kahnwong/terraform-sops-ssm\n1. Bootstrap Terraform terraform { required_providers { sops = { source = \"carlpett/sops\" version = \"0.6.3\" } } } provider \"aws\" { region = \"ap-southeast-1\" profile = \"playground\" } provider \"sops\" {} terraform { required_version = \"\u003e= 1.0\" } 2. Create KMS key for SOPS https://github.com/mozilla/sops/#kms-aws-profiles\nresource \"aws_kms_key\" \"sops\" { description = \"Keys to decrypt SOPS encrypted values\" } resource \"aws_kms_alias\" \"sops\" { name = \"alias/sops\" target_key_id = aws_kms_key.sops.key_id } 3. Create SSM secrets Create a folder named secrets, inside it create JSON files and encrypt each with sops.\nlocals { secrets = toset([ \"db-foo\", ]) } data \"sops_file\" \"sops_secrets\" { for_each = local.secrets source_file = \"secrets/${each.key}.sops.json\" } # aws keeps the secrets for 7 days before actual deletion. consider using random names during test resource \"aws_secretsmanager_secret\" \"ssm_secrets\" { for_each = local.secrets name = each.key } resource \"aws_secretsmanager_secret_version\" \"ssm_secrets\" { for_each = local.secrets secret_id = aws_secretsmanager_secret.ssm_secrets[\"${each.key}\"].id secret_string = jsonencode(data.sops_file.sops_secrets[\"${each.key}\"].data) } 4. Create IAM policy for SSM access data \"aws_iam_policy_document\" \"secrets_ro\" { statement { actions = [ \"secretsmanager:GetResourcePolicy\", \"secretsmanager:GetSecretValue\", \"secretsmanager:DescribeSecret\", \"secretsmanager:ListSecretVersionIds\" ] resources = [ \"arn:aws:secretsmanager:ap-southeast-1:$AWS_ACCOUNT_ID:secret:*\", ] } statement { actions = [ \"secretsmanager:ListSecrets\" ] resources = [\"*\"] } } resource \"aws_iam_policy\" \"secrets_ro\" { name = \"secrets_ro\" path = \"/\" policy = data.aws_iam_policy_document.secrets_ro.json } 5. Create IAM user for local dev You shouldn’t supply AWS credentials for deployment, since you can grant access via IAM roles instead.\nresource \"aws_iam_user\" \"playground-prod-dev\" { name = \"playground-prod-dev\" path = \"/users/\" } resource \"aws_iam_access_key\" \"playground-prod-dev\" { user = aws_iam_user.playground-prod-dev.name } Grant IAM user access to SSM resource \"aws_iam_user_policy_attachment\" \"playground-prod-dev\" { user = aws_iam_user.playground-prod-dev.name for_each = toset([ aws_iam_policy.secrets_ro.arn, ]) policy_arn = each.value } 6. Create IAM role for Lambda resource \"aws_iam_role\" \"lambda_role\" { name = \"lambda_role\" path = \"/sa/\" assume_role_policy = jsonencode({ Version = \"2012-10-17\" Statement = [ { \"Effect\" : \"Allow\", \"Principal\" : { \"Service\" : \"lambda.amazonaws.com\" }, \"Action\" : \"sts:AssumeRole\" }, ] }) managed_policy_arns = [ aws_iam_policy.secrets_ro.arn, ] inline_policy { name = \"create_cloudwatch_logs\" policy = jsonencode({ \"Version\" : \"2012-10-17\", \"Statement\" : [ { \"Action\" : [ \"logs:CreateLogGroup\", \"logs:CreateLogStream\", \"logs:PutLogEvents\" ], \"Effect\" : \"Allow\", \"Resource\" : \"*\" }, ] }) } } 7. Create IAM role for GitHub actions Need to create OIDC so GitHub can assume AWS roles\nresource \"aws_iam_openid_connect_provider\" \"github\" { url = \"https://token.actions.githubusercontent.com\" client_id_list = [\"sts.amazonaws.com\"] thumbprint_list = [\"a031c46782e6e6c662c2c87c76da9aa62ccabd8e\"] } Assume role policy is on per-repo basis\nlocals { repositories = [ \"terraform-sops-ssm\", ] } data \"aws_iam_policy_document\" \"github_actions_assume_role\" { statement { actions = [\"sts:AssumeRoleWithWebIdentity\"] principals { type = \"Federated\" identifiers = [aws_iam_openid_connect_provider.github.arn] } condition { test = \"ForAnyValue:StringLike\" variable = \"token.actions.githubusercontent.com:sub\" values = [for v in local.repositories : \"repo:kahnwong/${v}:*\"] } } } Finally attach the above policy to role\nresource \"aws_iam_role\" \"playground-prod-github\" { name = \"playground-prod-github\" path = \"/sa/\" assume_role_policy = data.aws_iam_policy_document.github_actions_assume_role.json managed_policy_arns = [ aws_iam_policy.secrets_ro.arn, ] } The end 🎉\nBonus GitHub actions with AWS login AWS Lambda with SSM template ","wordCount":"641","inLanguage":"en","datePublished":"2021-11-30T20:11:12+07:00","dateModified":"2021-11-30T20:11:12+07:00","author":{"@type":"Person","name":"Karn Wong"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.karnwong.me/posts/2021/11/secrets-management-with-sops-aws-ssm-terraform/"},"publisher":{"@type":"Organization","name":"Karn Wong","logo":{"@type":"ImageObject","url":"https://www.karnwong.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.karnwong.me/ accesskey=h title="Karn Wong (Alt + H)">Karn Wong</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.karnwong.me/about/ title=About><span>About</span></a></li><li><a href=https://www.karnwong.me/posts title=Posts><span>Posts</span></a></li><li><a href=https://www.karnwong.me/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://www.karnwong.me/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://www.karnwong.me/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.karnwong.me/>Home</a>&nbsp;»&nbsp;<a href=https://www.karnwong.me/posts/>Posts</a></div><h1 class=post-title>Secrets management with SOPS, AWS SSM and Terraform</h1><div class=post-meta><span title='2021-11-30 20:11:12 +0700 +07'>November 30, 2021</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;Karn Wong</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#implementation aria-label=Implementation>Implementation</a><ul><li><a href=#1-bootstrap-terraform aria-label="1. Bootstrap Terraform">1. Bootstrap Terraform</a></li><li><a href=#2-create-kms-key-for-sops aria-label="2. Create KMS key for SOPS">2. Create KMS key for SOPS</a></li><li><a href=#3-create-ssm-secrets aria-label="3. Create SSM secrets">3. Create SSM secrets</a></li><li><a href=#4-create-iam-policy-for-ssm-access aria-label="4. Create IAM policy for SSM access">4. Create IAM policy for SSM access</a></li><li><a href=#5-create-iam-user-for-local-dev aria-label="5. Create IAM user for local dev">5. Create IAM user for local dev</a><ul><li><a href=#grant-iam-user-access-to-ssm aria-label="Grant IAM user access to SSM">Grant IAM user access to SSM</a></li></ul></li><li><a href=#6-create-iam-role-for-lambda aria-label="6. Create IAM role for Lambda">6. Create IAM role for Lambda</a></li><li><a href=#7-create-iam-role-for-github-actions aria-label="7. Create IAM role for GitHub actions">7. Create IAM role for GitHub actions</a></li></ul></li><li><a href=#bonus aria-label=Bonus>Bonus</a></li></ul></div></details></div><div class=post-content><p>At my organization we use sops to check in encrypted secrets into git repos. This solves plaintext credentials in version control. However, say, you have 5 repos using the same database credentials, rotating secrets means you have to go into each repo and update the SOPS credentials manually.</p><p>Also worth nothing that, for GitHub actions, authenticating AWS means you have to add repo secrets. This means for all the repos you have CI enabled, you have to populate the repo secrets with AWS credentials. When time comes for rotating the creds, you&rsquo;ll encounter the same situation as above.</p><p>I did some research and consensus for AWS / Terraform setup is to: encrypt secrets via SOPS, and use Terraform to create AWS SSM secret entries. That way, you have a trail for credentials. This setup means:</p><ol><li>You don&rsquo;t have to populate repos with AWS creds, instead supplying an ARN role instead.</li><li>You don&rsquo;t have to change credentials in projects, since they all get the secrets from AWS SSM.</li></ol><h2 id=implementation>Implementation<a hidden class=anchor aria-hidden=true href=#implementation>#</a></h2><p>Repo here: <a href=https://github.com/kahnwong/terraform-sops-ssm>https://github.com/kahnwong/terraform-sops-ssm</a></p><h3 id=1-bootstrap-terraform>1. Bootstrap Terraform<a hidden class=anchor aria-hidden=true href=#1-bootstrap-terraform>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>terraform</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>required_providers</span> {
</span></span><span style=display:flex><span>    sops <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      source  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;carlpett/sops&#34;</span>
</span></span><span style=display:flex><span>      version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.6.3&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;aws&#34;</span> {
</span></span><span style=display:flex><span>  region  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ap-southeast-1&#34;</span>
</span></span><span style=display:flex><span>  profile <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;playground&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;sops&#34;</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>terraform</span> {
</span></span><span style=display:flex><span>  required_version <span style=color:#f92672>=</span> &#34;&gt;<span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-create-kms-key-for-sops>2. Create KMS key for SOPS<a hidden class=anchor aria-hidden=true href=#2-create-kms-key-for-sops>#</a></h3><p><a href=https://github.com/mozilla/sops/#kms-aws-profiles>https://github.com/mozilla/sops/#kms-aws-profiles</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_kms_key&#34; &#34;sops&#34;</span> {
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Keys to decrypt SOPS encrypted values&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_kms_alias&#34; &#34;sops&#34;</span> {
</span></span><span style=display:flex><span>  name          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;alias/sops&#34;</span>
</span></span><span style=display:flex><span>  target_key_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_kms_key</span>.<span style=color:#66d9ef>sops</span>.<span style=color:#66d9ef>key_id</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=3-create-ssm-secrets>3. Create SSM secrets<a hidden class=anchor aria-hidden=true href=#3-create-ssm-secrets>#</a></h3><p>Create a folder named <code>secrets</code>, inside it create JSON files and encrypt each with sops.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>locals</span> {
</span></span><span style=display:flex><span>  secrets <span style=color:#f92672>=</span> <span style=color:#66d9ef>toset</span>([
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;db-foo&#34;</span>,
</span></span><span style=display:flex><span>  ])
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;sops_file&#34; &#34;sops_secrets&#34;</span> {
</span></span><span style=display:flex><span>  for_each    <span style=color:#f92672>=</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>secrets</span>
</span></span><span style=display:flex><span>  source_file <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;secrets/${each.key}.sops.json&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># aws keeps the secrets for 7 days before actual deletion. consider using random names during test
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_secretsmanager_secret&#34; &#34;ssm_secrets&#34;</span> {
</span></span><span style=display:flex><span>  for_each <span style=color:#f92672>=</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>secrets</span>
</span></span><span style=display:flex><span>  name     <span style=color:#f92672>=</span> <span style=color:#66d9ef>each</span>.<span style=color:#66d9ef>key</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_secretsmanager_secret_version&#34; &#34;ssm_secrets&#34;</span> {
</span></span><span style=display:flex><span>  for_each      <span style=color:#f92672>=</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>secrets</span>
</span></span><span style=display:flex><span>  secret_id     <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_secretsmanager_secret</span>.<span style=color:#66d9ef>ssm_secrets</span>[<span style=color:#e6db74>&#34;${each.key}&#34;</span>].<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  secret_string <span style=color:#f92672>=</span> <span style=color:#66d9ef>jsonencode</span>(<span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>sops_file</span>.<span style=color:#66d9ef>sops_secrets</span>[<span style=color:#e6db74>&#34;${each.key}&#34;</span>].<span style=color:#66d9ef>data</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=4-create-iam-policy-for-ssm-access>4. Create IAM policy for SSM access<a hidden class=anchor aria-hidden=true href=#4-create-iam-policy-for-ssm-access>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;aws_iam_policy_document&#34; &#34;secrets_ro&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>statement</span> {
</span></span><span style=display:flex><span>    actions <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;secretsmanager:GetResourcePolicy&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;secretsmanager:GetSecretValue&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;secretsmanager:DescribeSecret&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;secretsmanager:ListSecretVersionIds&#34;</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>    resources <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;arn:aws:secretsmanager:ap-southeast-1:$AWS_ACCOUNT_ID:secret:*&#34;</span>,
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>statement</span> {
</span></span><span style=display:flex><span>    actions <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;secretsmanager:ListSecrets&#34;</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>    resources <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;*&#34;</span>]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_policy&#34; &#34;secrets_ro&#34;</span> {
</span></span><span style=display:flex><span>  name   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;secrets_ro&#34;</span>
</span></span><span style=display:flex><span>  path   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>  policy <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>aws_iam_policy_document</span>.<span style=color:#66d9ef>secrets_ro</span>.<span style=color:#66d9ef>json</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=5-create-iam-user-for-local-dev>5. Create IAM user for local dev<a hidden class=anchor aria-hidden=true href=#5-create-iam-user-for-local-dev>#</a></h3><p>You shouldn&rsquo;t supply AWS credentials for deployment, since you can grant access via IAM roles instead.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_user&#34; &#34;playground-prod-dev&#34;</span> {
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;playground-prod-dev&#34;</span>
</span></span><span style=display:flex><span>  path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/users/&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_access_key&#34; &#34;playground-prod-dev&#34;</span> {
</span></span><span style=display:flex><span>  user <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_iam_user</span>.<span style=color:#66d9ef>playground</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>prod</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>dev</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=grant-iam-user-access-to-ssm>Grant IAM user access to SSM<a hidden class=anchor aria-hidden=true href=#grant-iam-user-access-to-ssm>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_user_policy_attachment&#34; &#34;playground-prod-dev&#34;</span> {
</span></span><span style=display:flex><span>  user <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_iam_user</span>.<span style=color:#66d9ef>playground</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>prod</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>dev</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  for_each <span style=color:#f92672>=</span> <span style=color:#66d9ef>toset</span>([
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>aws_iam_policy</span>.<span style=color:#66d9ef>secrets_ro</span>.<span style=color:#66d9ef>arn</span>,
</span></span><span style=display:flex><span>  ])
</span></span><span style=display:flex><span>  policy_arn <span style=color:#f92672>=</span> <span style=color:#66d9ef>each</span>.<span style=color:#66d9ef>value</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=6-create-iam-role-for-lambda>6. Create IAM role for Lambda<a hidden class=anchor aria-hidden=true href=#6-create-iam-role-for-lambda>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_role&#34; &#34;lambda_role&#34;</span> {
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lambda_role&#34;</span>
</span></span><span style=display:flex><span>  path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/sa/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  assume_role_policy <span style=color:#f92672>=</span> <span style=color:#66d9ef>jsonencode</span>({
</span></span><span style=display:flex><span>    Version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;2012-10-17&#34;</span>
</span></span><span style=display:flex><span>    Statement <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Effect&#34; : &#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Principal&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;Service&#34; : &#34;lambda.amazonaws.com&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Action&#34; : &#34;sts:AssumeRole&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  managed_policy_arns <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>aws_iam_policy</span>.<span style=color:#66d9ef>secrets_ro</span>.<span style=color:#66d9ef>arn</span>,
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>inline_policy</span> {
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;create_cloudwatch_logs&#34;</span>
</span></span><span style=display:flex><span>    policy <span style=color:#f92672>=</span> <span style=color:#66d9ef>jsonencode</span>({
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;Version&#34; : &#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;Statement&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;Action&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;logs:CreateLogGroup&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;logs:CreateLogStream&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;logs:PutLogEvents&#34;</span>
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;Effect&#34; : &#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;Resource&#34; : &#34;*&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=7-create-iam-role-for-github-actions>7. Create IAM role for GitHub actions<a hidden class=anchor aria-hidden=true href=#7-create-iam-role-for-github-actions>#</a></h3><p>Need to create OIDC so GitHub can assume AWS roles</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_openid_connect_provider&#34; &#34;github&#34;</span> {
</span></span><span style=display:flex><span>  url             <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://token.actions.githubusercontent.com&#34;</span>
</span></span><span style=display:flex><span>  client_id_list  <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;sts.amazonaws.com&#34;</span>]
</span></span><span style=display:flex><span>  thumbprint_list <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;a031c46782e6e6c662c2c87c76da9aa62ccabd8e&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Assume role policy is on per-repo basis</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>locals</span> {
</span></span><span style=display:flex><span>  repositories <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;terraform-sops-ssm&#34;</span>,
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;aws_iam_policy_document&#34; &#34;github_actions_assume_role&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>statement</span> {
</span></span><span style=display:flex><span>    actions <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;sts:AssumeRoleWithWebIdentity&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>principals</span> {
</span></span><span style=display:flex><span>      type        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Federated&#34;</span>
</span></span><span style=display:flex><span>      identifiers <span style=color:#f92672>=</span> [<span style=color:#66d9ef>aws_iam_openid_connect_provider</span>.<span style=color:#66d9ef>github</span>.<span style=color:#66d9ef>arn</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>condition</span> {
</span></span><span style=display:flex><span>      test     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ForAnyValue:StringLike&#34;</span>
</span></span><span style=display:flex><span>      variable <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;token.actions.githubusercontent.com:sub&#34;</span>
</span></span><span style=display:flex><span>      values   <span style=color:#f92672>=</span> [<span style=color:#66d9ef>for</span> <span style=color:#66d9ef>v</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>local</span>.<span style=color:#66d9ef>repositories</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;repo:kahnwong/${v}:*&#34;</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Finally attach the above policy to role</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_role&#34; &#34;playground-prod-github&#34;</span> {
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;playground-prod-github&#34;</span>
</span></span><span style=display:flex><span>  path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/sa/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  assume_role_policy <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>aws_iam_policy_document</span>.<span style=color:#66d9ef>github_actions_assume_role</span>.<span style=color:#66d9ef>json</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  managed_policy_arns <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>aws_iam_policy</span>.<span style=color:#66d9ef>secrets_ro</span>.<span style=color:#66d9ef>arn</span>,
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The end 🎉</p><h2 id=bonus>Bonus<a hidden class=anchor aria-hidden=true href=#bonus>#</a></h2><ul><li><a href=https://github.com/kahnwong/terraform-sops-ssm/blob/master/.github/workflows/deploy.yml>GitHub actions with AWS login</a></li><li><a href=https://github.com/kahnwong/terraform-sops-ssm/tree/master/app>AWS Lambda with SSM template</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.karnwong.me/tags/devops/>devops</a></li><li><a href=https://www.karnwong.me/tags/aws/>aws</a></li><li><a href=https://www.karnwong.me/tags/github/>github</a></li><li><a href=https://www.karnwong.me/tags/terraform/>terraform</a></li></ul><nav class=paginav><a class=prev href=https://www.karnwong.me/posts/2021/12/reduce-docker-image-size-with-alpine/><span class=title>« Prev</span><br><span>Reduce docker image size with alpine</span></a>
<a class=next href=https://www.karnwong.me/posts/2021/11/run-github-actions-faster-with-cache-for-pipenv-and-docker-build/><span class=title>Next »</span><br><span>Run GitHub Actions faster with cache for pipenv and docker build</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://www.karnwong.me/>Karn Wong</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>