<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Workarounds for archiving large shapefile in data lake | Karn Wong</title><meta name=keywords content="data engineering,gis"><meta name=description content="If you work with spatial data, chances are you are familiar with shapefile, a file format for viewing / editing spatial data.
Essentially, shapefile is just a tabular data like csv, but it does thingamajig with geometry data type, where any gis tools like qgis or arcgis can understand right away. If you have a csv file with geometry column in wkt format (something like POLYGON ((30 10, 40 40, 20 40, 10 20, 30 10))), you&rsquo;ll have to specify which column is to be used for geometry."><meta name=author content="Karn Wong"><link rel=canonical href=https://www.karnwong.me/posts/2021/01/workarounds-for-archiving-large-shapefile-in-data-lake/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.karnwong.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.karnwong.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.karnwong.me/favicon-32x32.png><link rel=apple-touch-icon href=https://www.karnwong.me/apple-touch-icon.png><link rel=mask-icon href=https://www.karnwong.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-8CYMFC0KZ9"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8CYMFC0KZ9",{anonymize_ip:!1})}</script><meta property="og:title" content="Workarounds for archiving large shapefile in data lake"><meta property="og:description" content="If you work with spatial data, chances are you are familiar with shapefile, a file format for viewing / editing spatial data.
Essentially, shapefile is just a tabular data like csv, but it does thingamajig with geometry data type, where any gis tools like qgis or arcgis can understand right away. If you have a csv file with geometry column in wkt format (something like POLYGON ((30 10, 40 40, 20 40, 10 20, 30 10))), you&rsquo;ll have to specify which column is to be used for geometry."><meta property="og:type" content="article"><meta property="og:url" content="https://www.karnwong.me/posts/2021/01/workarounds-for-archiving-large-shapefile-in-data-lake/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-31T17:40:53+00:00"><meta property="article:modified_time" content="2021-01-31T17:40:53+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Workarounds for archiving large shapefile in data lake"><meta name=twitter:description content="If you work with spatial data, chances are you are familiar with shapefile, a file format for viewing / editing spatial data.
Essentially, shapefile is just a tabular data like csv, but it does thingamajig with geometry data type, where any gis tools like qgis or arcgis can understand right away. If you have a csv file with geometry column in wkt format (something like POLYGON ((30 10, 40 40, 20 40, 10 20, 30 10))), you&rsquo;ll have to specify which column is to be used for geometry."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.karnwong.me/posts/"},{"@type":"ListItem","position":2,"name":"Workarounds for archiving large shapefile in data lake","item":"https://www.karnwong.me/posts/2021/01/workarounds-for-archiving-large-shapefile-in-data-lake/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Workarounds for archiving large shapefile in data lake","name":"Workarounds for archiving large shapefile in data lake","description":"If you work with spatial data, chances are you are familiar with shapefile, a file format for viewing / editing spatial data.\nEssentially, shapefile is just a tabular data like csv, but it does thingamajig with geometry data type, where any gis tools like qgis or arcgis can understand right away. If you have a csv file with geometry column in wkt format (something like POLYGON ((30 10, 40 40, 20 40, 10 20, 30 10))), you\u0026rsquo;ll have to specify which column is to be used for geometry.","keywords":["data engineering","gis"],"articleBody":"If you work with spatial data, chances are you are familiar with shapefile, a file format for viewing / editing spatial data.\nEssentially, shapefile is just a tabular data like csv, but it does thingamajig with geometry data type, where any gis tools like qgis or arcgis can understand right away. If you have a csv file with geometry column in wkt format (something like POLYGON ((30 10, 40 40, 20 40, 10 20, 30 10))), you’ll have to specify which column is to be used for geometry.\nIf you want to store shapefile in data lake, it’s best to store it as parquet or any format you normally use, since it’s faster to read and filter. For comparison, parsing a 5GB+ shapefile and filter takes longer than reading a gzipped json, filter, and export to shapefile.\nNormally I would use geopandas to read spatial data and convert it to pandas dataframe, then send it to spark. But since the shapefile is very large, it takes forever to read in geopandas. This tells me that there is a parsing bottleneck going on. And geopandas can’t read shapefile with multiple geometry types (this shouldn’t happen, but sometimes during editing, clipping this here and there can cause invalid geometry).\nQgis has a tool to fix invalid geometries, so I tried exporting shapefile to csv, but qgis went OOM. But both qgis and geopandas use gdal for backend, and it has a CLI interface, so I look up how to export shapefile to tsv (tab as a seperator makes it faster to parse since it rarely occurs).\nNow things work perfectly. As a bonus, gdal also skip invalid geometries by default (unlike in geopandas where it will throw an error and there’s no way to ignore it and tell the parser to keep going).\nAt this point I have a nice tsv file, and reading \u0026 archiving via spark is now a breeze. Yay!\nTakeaway If it takes too long to read, maybe it’s a parsing bottleneck. Find a way to convert it to another format so it’s easier to parse. Sometimes your initial tools of choice might have some quirks. In most cases there will be similar tools out there that can workaround the issues. (In this case, use gdal to convert to csv in lieu of geopandas because gpd can’t work with invalid geometries \u0026 takes longer to read compared to feeding spark a straight csv/tsv). ","wordCount":"405","inLanguage":"en","datePublished":"2021-01-31T17:40:53Z","dateModified":"2021-01-31T17:40:53Z","author":{"@type":"Person","name":"Karn Wong"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.karnwong.me/posts/2021/01/workarounds-for-archiving-large-shapefile-in-data-lake/"},"publisher":{"@type":"Organization","name":"Karn Wong","logo":{"@type":"ImageObject","url":"https://www.karnwong.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.karnwong.me/ accesskey=h title="Karn Wong (Alt + H)">Karn Wong</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.karnwong.me/about/ title=About><span>About</span></a></li><li><a href=https://www.karnwong.me/posts title=Posts><span>Posts</span></a></li><li><a href=https://www.karnwong.me/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://www.karnwong.me/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://www.karnwong.me/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.karnwong.me/>Home</a>&nbsp;»&nbsp;<a href=https://www.karnwong.me/posts/>Posts</a></div><h1 class=post-title>Workarounds for archiving large shapefile in data lake</h1><div class=post-meta><span title='2021-01-31 17:40:53 +0000 UTC'>January 31, 2021</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;Karn Wong</div></header><div class=post-content><p>If you work with spatial data, chances are you are familiar with <code>shapefile</code>, a file format for viewing / editing spatial data.</p><p>Essentially, shapefile is just a tabular data like <code>csv</code>, but it does thingamajig with <code>geometry</code> data type, where any gis tools like <code>qgis</code> or <code>arcgis</code> can understand right away. If you have a csv file with geometry column in <code>wkt</code> format (something like <code>POLYGON ((30 10, 40 40, 20 40, 10 20, 30 10))</code>), you&rsquo;ll have to specify which column is to be used for geometry.</p><p>If you want to store shapefile in data lake, it&rsquo;s best to store it as parquet or any format you normally use, since it&rsquo;s faster to read and filter. For comparison, parsing a 5GB+ shapefile and filter takes <em>longer</em> than reading a gzipped json, filter, and export to shapefile.</p><p>Normally I would use <code>geopandas</code> to read spatial data and convert it to pandas dataframe, then send it to spark. But since the shapefile is very large, it takes forever to read in geopandas. This tells me that there is a parsing bottleneck going on. And geopandas can&rsquo;t read shapefile with multiple geometry types (this shouldn&rsquo;t happen, but sometimes during editing, clipping this here and there can cause invalid geometry).</p><p>Qgis has a tool to fix invalid geometries, so I tried exporting shapefile to csv, but qgis went OOM. But both qgis and geopandas use <code>gdal</code> for backend, and it has a CLI interface, so I look up how to export shapefile to tsv (<code>tab</code> as a seperator makes it faster to parse since it rarely occurs).</p><p>Now things work perfectly. As a bonus, gdal also skip invalid geometries by default (unlike in geopandas where it will throw an error and there&rsquo;s no way to ignore it and tell the parser to keep going).</p><p>At this point I have a nice tsv file, and reading & archiving via spark is now a breeze. Yay!</p><h1 id=takeaway>Takeaway<a hidden class=anchor aria-hidden=true href=#takeaway>#</a></h1><ul><li>If it takes too long to read, maybe it&rsquo;s a parsing bottleneck. Find a way to convert it to another format so it&rsquo;s easier to parse.</li><li>Sometimes your initial tools of choice might have some quirks. In most cases there will be similar tools out there that can workaround the issues. (In this case, use gdal to convert to csv in lieu of geopandas because gpd can&rsquo;t work with invalid geometries & takes longer to read compared to feeding spark a straight csv/tsv).</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.karnwong.me/tags/data-engineering/>data engineering</a></li><li><a href=https://www.karnwong.me/tags/gis/>gis</a></li></ul><nav class=paginav><a class=prev href=https://www.karnwong.me/posts/2021/02/buying-tea-when-you-have-celiac/><span class=title>« Prev</span><br><span>Buying tea when you have Celiac</span></a>
<a class=next href=https://www.karnwong.me/posts/2021/01/mongodb-export-woes/><span class=title>Next »</span><br><span>Mongodb export woes</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://www.karnwong.me/>Karn Wong</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>