<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Use SSH key during docker build without embedding the key via ssh-agent | Karn Wong</title><meta name=keywords content="devops,docker,github"><meta name=description content="Imagine working in a company, and they have a super cool internal module! The module works great, except that it is a private module, which means you need to install it by cloning the source repo and install it from source.
That shouldn&rsquo;t be an issue if you work on your local machine. But for production usually this means you somehow need to bundle this awesome module into your docker image."><meta name=author content="Karn Wong"><link rel=canonical href=https://www.karnwong.me/posts/2022/02/use-ssh-key-during-docker-build-without-embedding-the-key-via-ssh-agent/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.karnwong.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.karnwong.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.karnwong.me/favicon-32x32.png><link rel=apple-touch-icon href=https://www.karnwong.me/apple-touch-icon.png><link rel=mask-icon href=https://www.karnwong.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-8CYMFC0KZ9"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8CYMFC0KZ9",{anonymize_ip:!1})}</script><meta property="og:title" content="Use SSH key during docker build without embedding the key via ssh-agent"><meta property="og:description" content="Imagine working in a company, and they have a super cool internal module! The module works great, except that it is a private module, which means you need to install it by cloning the source repo and install it from source.
That shouldn&rsquo;t be an issue if you work on your local machine. But for production usually this means you somehow need to bundle this awesome module into your docker image."><meta property="og:type" content="article"><meta property="og:url" content="https://www.karnwong.me/posts/2022/02/use-ssh-key-during-docker-build-without-embedding-the-key-via-ssh-agent/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-06T15:06:16+07:00"><meta property="article:modified_time" content="2022-02-06T15:06:16+07:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Use SSH key during docker build without embedding the key via ssh-agent"><meta name=twitter:description content="Imagine working in a company, and they have a super cool internal module! The module works great, except that it is a private module, which means you need to install it by cloning the source repo and install it from source.
That shouldn&rsquo;t be an issue if you work on your local machine. But for production usually this means you somehow need to bundle this awesome module into your docker image."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.karnwong.me/posts/"},{"@type":"ListItem","position":2,"name":"Use SSH key during docker build without embedding the key via ssh-agent","item":"https://www.karnwong.me/posts/2022/02/use-ssh-key-during-docker-build-without-embedding-the-key-via-ssh-agent/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Use SSH key during docker build without embedding the key via ssh-agent","name":"Use SSH key during docker build without embedding the key via ssh-agent","description":"Imagine working in a company, and they have a super cool internal module! The module works great, except that it is a private module, which means you need to install it by cloning the source repo and install it from source.\nThat shouldn\u0026rsquo;t be an issue if you work on your local machine. But for production usually this means you somehow need to bundle this awesome module into your docker image.","keywords":["devops","docker","github"],"articleBody":"Imagine working in a company, and they have a super cool internal module! The module works great, except that it is a private module, which means you need to install it by cloning the source repo and install it from source.\nThat shouldnâ€™t be an issue if you work on your local machine. But for production usually this means you somehow need to bundle this awesome module into your docker image. You go create a Dockerfile and thereâ€™s one little problem: it couldnâ€™t clone the module repo because it doesnâ€™t have the required SSH key that can access the repo.\nA very simple solution would just be bundling the SSH key into the docker image itself. This works great, until security comes knocking because: anyone who can access the image can also access the source repo! And we wouldnâ€™t want that.\nSo whatâ€™s the solution? Luckily thereâ€™s a thing called ssh-agent forwarding. Think of it as passing an SSH key into docker during build, then poof! Itâ€™s gone.\nInstructions Set up SSH key on your host machine. This essentially means you should be able to perform git clone $REPO on the module repo. In your Dockerfile, add something like the following: # Authorize SSH Host RUN mkdir -p -m 700 /root/.ssh \u0026\u0026 \\ touch -m 600 /root/.ssh/known_hosts \u0026\u0026 \\ ssh-keyscan github.com \u003e /root/.ssh/known_hosts RUN --mount=type=ssh,id=github $SOME_COMMAND_THAT_NEEDS_SSH_KEY Build docker image with docker build --ssh github=$SSH_PRIVATE_KEY_PATH -t $IMAGE_NAME . GitHub Actions In GitHub actions, #1 is translated as:\n- name: Setup SSH Keys and known_hosts run: | mkdir -p ~/.ssh ssh-keyscan github.com \u003e\u003e ~/.ssh/known_hosts ssh-agent -a $SSH_AUTH_SOCK \u003e /dev/null ssh-add - \u003c\u003c\u003c \"${{ secrets.SSH_PRIVATE_KEY }}\" env: SSH_AUTH_SOCK: /tmp/ssh_agent.sock - name: Build, tag, and push image to Amazon ECR uses: docker/build-push-action@v2 env: SSH_AUTH_SOCK: /tmp/ssh_agent.sock with: context: . push: true tags: ${{ steps.meta.outputs.tags }} cache-from: type=gha cache-to: type=gha,mode=max ssh: | github=${{ env.SSH_AUTH_SOCK }} Voila ðŸŽ‰\n","wordCount":"311","inLanguage":"en","datePublished":"2022-02-06T15:06:16+07:00","dateModified":"2022-02-06T15:06:16+07:00","author":{"@type":"Person","name":"Karn Wong"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.karnwong.me/posts/2022/02/use-ssh-key-during-docker-build-without-embedding-the-key-via-ssh-agent/"},"publisher":{"@type":"Organization","name":"Karn Wong","logo":{"@type":"ImageObject","url":"https://www.karnwong.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.karnwong.me/ accesskey=h title="Karn Wong (Alt + H)">Karn Wong</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.karnwong.me/about/ title=About><span>About</span></a></li><li><a href=https://www.karnwong.me/posts title=Posts><span>Posts</span></a></li><li><a href=https://www.karnwong.me/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://www.karnwong.me/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://www.karnwong.me/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.karnwong.me/>Home</a>&nbsp;Â»&nbsp;<a href=https://www.karnwong.me/posts/>Posts</a></div><h1 class=post-title>Use SSH key during docker build without embedding the key via ssh-agent</h1><div class=post-meta><span title='2022-02-06 15:06:16 +0700 +07'>February 6, 2022</span>&nbsp;Â·&nbsp;2 min&nbsp;Â·&nbsp;Karn Wong</div></header><div class=post-content><p>Imagine working in a company, and they have a super cool internal module! The module works great, except that it is a private module, which means you need to install it by cloning the source repo and install it from source.</p><p>That shouldn&rsquo;t be an issue if you work on your local machine. But for production usually this means you somehow need to bundle this awesome module into your docker image. You go create a Dockerfile and there&rsquo;s one little problem: it couldn&rsquo;t clone the module repo because it doesn&rsquo;t have the required SSH key that can access the repo.</p><p>A very simple solution would just be bundling the SSH key into the docker image itself. This works great, until security comes knocking because: anyone who can access the image can also access the source repo! And we wouldn&rsquo;t want that.</p><p>So what&rsquo;s the solution? Luckily there&rsquo;s a thing called ssh-agent forwarding. Think of it as passing an SSH key into docker during build, then poof! It&rsquo;s gone.</p><h2 id=instructions>Instructions<a hidden class=anchor aria-hidden=true href=#instructions>#</a></h2><ol><li>Set up SSH key on your host machine. This essentially means you should be able to perform <code>git clone $REPO</code> on the module repo.</li><li>In your Dockerfile, add something like the following:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># Authorize SSH Host</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir -p -m <span style=color:#ae81ff>700</span> /root/.ssh <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    touch -m <span style=color:#ae81ff>600</span> /root/.ssh/known_hosts <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ssh-keyscan github.com &gt; /root/.ssh/known_hosts<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> --mount<span style=color:#f92672>=</span>type<span style=color:#f92672>=</span>ssh,id<span style=color:#f92672>=</span>github $SOME_COMMAND_THAT_NEEDS_SSH_KEY<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><ol start=3><li>Build docker image with <code>docker build --ssh github=$SSH_PRIVATE_KEY_PATH -t $IMAGE_NAME .</code></li></ol><h2 id=github-actions>GitHub Actions<a hidden class=anchor aria-hidden=true href=#github-actions>#</a></h2><p>In GitHub actions, #1 is translated as:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Setup SSH Keys and known_hosts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    mkdir -p ~/.ssh
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ssh-keyscan github.com &gt;&gt; ~/.ssh/known_hosts
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ssh-agent -a $SSH_AUTH_SOCK &gt; /dev/null
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ssh-add - &lt;&lt;&lt; &#34;${{ secrets.SSH_PRIVATE_KEY }}&#34;</span>    
</span></span><span style=display:flex><span>  <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>SSH_AUTH_SOCK</span>: <span style=color:#ae81ff>/tmp/ssh_agent.sock</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Build, tag, and push image to Amazon ECR</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>docker/build-push-action@v2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>SSH_AUTH_SOCK</span>: <span style=color:#ae81ff>/tmp/ssh_agent.sock</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>context</span>: <span style=color:#ae81ff>.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>push</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tags</span>: <span style=color:#ae81ff>${{ steps.meta.outputs.tags }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cache-from</span>: <span style=color:#ae81ff>type=gha</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cache-to</span>: <span style=color:#ae81ff>type=gha,mode=max</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssh</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      </span>      <span style=color:#ae81ff>github=${{ env.SSH_AUTH_SOCK }}</span>
</span></span></code></pre></div><p>Voila ðŸŽ‰</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.karnwong.me/tags/devops/>devops</a></li><li><a href=https://www.karnwong.me/tags/docker/>docker</a></li><li><a href=https://www.karnwong.me/tags/github/>github</a></li></ul><nav class=paginav><a class=prev href=https://www.karnwong.me/posts/2022/05/what-sql-cant-do-for-data-engineering/><span class=title>Â« Prev</span><br><span>What SQL can't do for data engineering</span></a>
<a class=next href=https://www.karnwong.me/posts/2021/12/use-pyspark-locally-with-docker/><span class=title>Next Â»</span><br><span>Use pyspark locally with docker</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://www.karnwong.me/>Karn Wong</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>