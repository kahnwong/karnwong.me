<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Minimal ECS task with fargate backend | Karn Wong</title><meta name=keywords content="devops,terraform,aws"><meta name=description content="To deploy a web application, there are many ways to go about it. I could spin up a bare VM and set up the environment manually. To make things easier, I could have package the app into docker image. But this still means I have to &ldquo;update&rdquo; the app manually if I add changes to it.
Things would be super cool if: after I push the changes to master branch, the app would be deployed automatically."><meta name=author content="Karn Wong"><link rel=canonical href=https://www.karnwong.me/posts/2022/08/minimal-ecs-task-with-fargate-backend/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.karnwong.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.karnwong.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.karnwong.me/favicon-32x32.png><link rel=apple-touch-icon href=https://www.karnwong.me/apple-touch-icon.png><link rel=mask-icon href=https://www.karnwong.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-8CYMFC0KZ9"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8CYMFC0KZ9",{anonymize_ip:!1})}</script><meta property="og:title" content="Minimal ECS task with fargate backend"><meta property="og:description" content="To deploy a web application, there are many ways to go about it. I could spin up a bare VM and set up the environment manually. To make things easier, I could have package the app into docker image. But this still means I have to &ldquo;update&rdquo; the app manually if I add changes to it.
Things would be super cool if: after I push the changes to master branch, the app would be deployed automatically."><meta property="og:type" content="article"><meta property="og:url" content="https://www.karnwong.me/posts/2022/08/minimal-ecs-task-with-fargate-backend/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-26T21:10:58+07:00"><meta property="article:modified_time" content="2022-08-26T21:10:58+07:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Minimal ECS task with fargate backend"><meta name=twitter:description content="To deploy a web application, there are many ways to go about it. I could spin up a bare VM and set up the environment manually. To make things easier, I could have package the app into docker image. But this still means I have to &ldquo;update&rdquo; the app manually if I add changes to it.
Things would be super cool if: after I push the changes to master branch, the app would be deployed automatically."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.karnwong.me/posts/"},{"@type":"ListItem","position":2,"name":"Minimal ECS task with fargate backend","item":"https://www.karnwong.me/posts/2022/08/minimal-ecs-task-with-fargate-backend/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Minimal ECS task with fargate backend","name":"Minimal ECS task with fargate backend","description":"To deploy a web application, there are many ways to go about it. I could spin up a bare VM and set up the environment manually. To make things easier, I could have package the app into docker image. But this still means I have to \u0026ldquo;update\u0026rdquo; the app manually if I add changes to it.\nThings would be super cool if: after I push the changes to master branch, the app would be deployed automatically.","keywords":["devops","terraform","aws"],"articleBody":"To deploy a web application, there are many ways to go about it. I could spin up a bare VM and set up the environment manually. To make things easier, I could have package the app into docker image. But this still means I have to ‚Äúupdate‚Äù the app manually if I add changes to it.\nThings would be super cool if: after I push the changes to master branch, the app would be deployed automatically. In order to achieve this, I could use AWS ECS task to deploy the app, and add CI/CD to it (because this is 2022 after all).\nAnd things would be even better if I don‚Äôt have to set up the infra manually every time I want to deploy an app, enters terraform!\nBelow are minimal ecs task with fargate backend setup üòé. Repo here.\nUpdated 2022-09-02\nNotes: you might need to set up autoscaling on LB connections per target. Also this example contains two target tracking policies for the same service. Race conditions can result in undesirable scaling issues. Thanks John Mille!\nTask definition This is equivalent to docker-compose.yaml\nresource \"aws_cloudwatch_log_group\" \"this\" { retention_in_days = 14 name = \"/aws/ecs/${var.service_name}\" } resource \"aws_ecs_task_definition\" \"this\" { family = var.service_name network_mode = \"awsvpc\" requires_compatibilities = [\"FARGATE\"] cpu = 256 memory = 512 execution_role_arn = var.task_role task_role_arn = var.task_role container_definitions = jsonencode( [ { name = var.service_name image = var.image_uri essential = true environment = [] portMappings = [ { protocol = \"tcp\" containerPort = 80 hostPort = 80 } ] logConfiguration = { logDriver = \"awslogs\" options = { awslogs-group = aws_cloudwatch_log_group.this.name awslogs-region = var.aws_region awslogs-stream-prefix = \"ecs\" } } } ] ) } resource \"aws_ecs_service\" \"this\" { name = var.service_name cluster = var.ecs_cluster_id task_definition = aws_ecs_task_definition.this.arn desired_count = 1 deployment_minimum_healthy_percent = 50 deployment_maximum_percent = 200 launch_type = \"FARGATE\" scheduling_strategy = \"REPLICA\" network_configuration { security_groups = [var.alb_id] subnets = var.subnet_id assign_public_ip = true } load_balancer { target_group_arn = aws_alb_target_group.this.arn container_name = var.service_name container_port = 80 } } SSL certificate resource \"aws_acm_certificate\" \"this\" { domain_name = var.domain_name validation_method = \"DNS\" lifecycle { create_before_destroy = true } tags = { Name = var.domain_name } } Load balancer resource \"aws_lb\" \"this\" { name = var.service_name internal = false load_balancer_type = \"application\" security_groups = [var.alb_id] subnets = var.subnet_id idle_timeout = 3600 enable_deletion_protection = true } resource \"aws_alb_target_group\" \"this\" { name = var.service_name port = 80 protocol = \"HTTP\" vpc_id = var.vpc_id target_type = \"ip\" health_check { healthy_threshold = \"3\" interval = \"30\" protocol = \"HTTP\" matcher = \"200\" timeout = \"3\" path = var.health_check_path unhealthy_threshold = \"2\" } } resource \"aws_alb_listener\" \"http\" { load_balancer_arn = aws_lb.this.id port = 80 protocol = \"HTTP\" default_action { type = \"forward\" target_group_arn = aws_alb_target_group.this.arn } } resource \"aws_alb_listener\" \"https\" { load_balancer_arn = aws_lb.this.id port = 443 protocol = \"HTTPS\" ssl_policy = \"ELBSecurityPolicy-2016-08\" certificate_arn = aws_acm_certificate.this.arn default_action { target_group_arn = aws_alb_target_group.this.id type = \"forward\" } } Autoscaling Because we are using cloud, and I love taking advantage of dynamic resources allocation.\nresource \"aws_appautoscaling_target\" \"this\" { max_capacity = 2 min_capacity = 1 resource_id = \"service/${var.ecs_cluster_name}/${aws_ecs_service.this.name}\" scalable_dimension = \"ecs:service:DesiredCount\" service_namespace = \"ecs\" } resource \"aws_appautoscaling_policy\" \"memory\" { name = \"memory-autoscaling\" policy_type = \"TargetTrackingScaling\" resource_id = aws_appautoscaling_target.this.resource_id scalable_dimension = aws_appautoscaling_target.this.scalable_dimension service_namespace = aws_appautoscaling_target.this.service_namespace target_tracking_scaling_policy_configuration { predefined_metric_specification { predefined_metric_type = \"ECSServiceAverageMemoryUtilization\" } target_value = 40 } } resource \"aws_appautoscaling_policy\" \"cpu\" { name = \"cpu-autoscaling\" policy_type = \"TargetTrackingScaling\" resource_id = aws_appautoscaling_target.this.resource_id scalable_dimension = aws_appautoscaling_target.this.scalable_dimension service_namespace = aws_appautoscaling_target.this.service_namespace target_tracking_scaling_policy_configuration { predefined_metric_specification { predefined_metric_type = \"ECSServiceAverageCPUUtilization\" } target_value = 60 } } ","wordCount":"579","inLanguage":"en","datePublished":"2022-08-26T21:10:58+07:00","dateModified":"2022-08-26T21:10:58+07:00","author":{"@type":"Person","name":"Karn Wong"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.karnwong.me/posts/2022/08/minimal-ecs-task-with-fargate-backend/"},"publisher":{"@type":"Organization","name":"Karn Wong","logo":{"@type":"ImageObject","url":"https://www.karnwong.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.karnwong.me/ accesskey=h title="Karn Wong (Alt + H)">Karn Wong</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.karnwong.me/about/ title=About><span>About</span></a></li><li><a href=https://www.karnwong.me/posts title=Posts><span>Posts</span></a></li><li><a href=https://www.karnwong.me/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://www.karnwong.me/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://www.karnwong.me/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.karnwong.me/>Home</a>&nbsp;¬ª&nbsp;<a href=https://www.karnwong.me/posts/>Posts</a></div><h1 class=post-title>Minimal ECS task with fargate backend</h1><div class=post-meta><span title='2022-08-26 21:10:58 +0700 +07'>August 26, 2022</span>&nbsp;¬∑&nbsp;3 min&nbsp;¬∑&nbsp;Karn Wong</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#task-definition aria-label="Task definition">Task definition</a></li><li><a href=#ssl-certificate aria-label="SSL certificate">SSL certificate</a></li><li><a href=#load-balancer aria-label="Load balancer">Load balancer</a></li><li><a href=#autoscaling aria-label=Autoscaling>Autoscaling</a></li></ul></div></details></div><div class=post-content><p>To deploy a web application, there are many ways to go about it. I could spin up a bare VM and set up the environment manually. To make things easier, I could have package the app into docker image. But this still means I have to &ldquo;update&rdquo; the app manually if I add changes to it.</p><p>Things would be super cool if: after I push the changes to master branch, the app would be deployed automatically. In order to achieve this, I could use AWS ECS task to deploy the app, and add CI/CD to it (because this is 2022 after all).</p><p>And things would be even better if I don&rsquo;t have to set up the infra manually every time I want to deploy an app, enters terraform!</p><p>Below are minimal ecs task with fargate backend setup üòé. Repo <a href=https://github.com/devbaygroup/terraform-aws-ecs-fargate-example>here</a>.</p><p><em>Updated 2022-09-02</em></p><p>Notes: you might need to set up autoscaling on LB connections per target. Also this example contains two target tracking policies for the same service. Race conditions can result in undesirable scaling issues. Thanks John Mille!</p><h2 id=task-definition>Task definition<a hidden class=anchor aria-hidden=true href=#task-definition>#</a></h2><p>This is equivalent to docker-compose.yaml</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_cloudwatch_log_group&#34; &#34;this&#34;</span> {
</span></span><span style=display:flex><span>  retention_in_days <span style=color:#f92672>=</span> <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>  name              <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/aws/ecs/${var.service_name}&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_ecs_task_definition&#34; &#34;this&#34;</span> {
</span></span><span style=display:flex><span>  family                   <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>service_name</span>
</span></span><span style=display:flex><span>  network_mode             <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;awsvpc&#34;</span>
</span></span><span style=display:flex><span>  requires_compatibilities <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;FARGATE&#34;</span>]
</span></span><span style=display:flex><span>  cpu                      <span style=color:#f92672>=</span> <span style=color:#ae81ff>256</span>
</span></span><span style=display:flex><span>  memory                   <span style=color:#f92672>=</span> <span style=color:#ae81ff>512</span>
</span></span><span style=display:flex><span>  execution_role_arn       <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>task_role</span>
</span></span><span style=display:flex><span>  task_role_arn            <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>task_role</span>
</span></span><span style=display:flex><span>  container_definitions <span style=color:#f92672>=</span> <span style=color:#66d9ef>jsonencode</span>(
</span></span><span style=display:flex><span>    [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        name        <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>service_name</span>
</span></span><span style=display:flex><span>        image       <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>image_uri</span>
</span></span><span style=display:flex><span>        essential   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        environment <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        portMappings <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            protocol      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tcp&#34;</span>
</span></span><span style=display:flex><span>            containerPort <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>            hostPort      <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>        logConfiguration <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          logDriver <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;awslogs&#34;</span>
</span></span><span style=display:flex><span>          options <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            awslogs-group         <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_cloudwatch_log_group</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>            awslogs-region        <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>aws_region</span>
</span></span><span style=display:flex><span>            awslogs-stream-prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ecs&#34;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_ecs_service&#34; &#34;this&#34;</span> {
</span></span><span style=display:flex><span>  name                               <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>service_name</span>
</span></span><span style=display:flex><span>  cluster                            <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>ecs_cluster_id</span>
</span></span><span style=display:flex><span>  task_definition                    <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_ecs_task_definition</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>arn</span>
</span></span><span style=display:flex><span>  desired_count                      <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  deployment_minimum_healthy_percent <span style=color:#f92672>=</span> <span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span>  deployment_maximum_percent         <span style=color:#f92672>=</span> <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>  launch_type                        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;FARGATE&#34;</span>
</span></span><span style=display:flex><span>  scheduling_strategy                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;REPLICA&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>network_configuration</span> {
</span></span><span style=display:flex><span>    security_groups  <span style=color:#f92672>=</span> [<span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>alb_id</span>]
</span></span><span style=display:flex><span>    subnets          <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>subnet_id</span>
</span></span><span style=display:flex><span>    assign_public_ip <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>load_balancer</span> {
</span></span><span style=display:flex><span>    target_group_arn <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_alb_target_group</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>arn</span>
</span></span><span style=display:flex><span>    container_name   <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>service_name</span>
</span></span><span style=display:flex><span>    container_port   <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=ssl-certificate>SSL certificate<a hidden class=anchor aria-hidden=true href=#ssl-certificate>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_acm_certificate&#34; &#34;this&#34;</span> {
</span></span><span style=display:flex><span>  domain_name       <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>domain_name</span>
</span></span><span style=display:flex><span>  validation_method <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;DNS&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>lifecycle</span> {
</span></span><span style=display:flex><span>    create_before_destroy <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>domain_name</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=load-balancer>Load balancer<a hidden class=anchor aria-hidden=true href=#load-balancer>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_lb&#34; &#34;this&#34;</span> {
</span></span><span style=display:flex><span>  name               <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>service_name</span>
</span></span><span style=display:flex><span>  internal           <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  load_balancer_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;application&#34;</span>
</span></span><span style=display:flex><span>  security_groups    <span style=color:#f92672>=</span> [<span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>alb_id</span>]
</span></span><span style=display:flex><span>  subnets            <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>subnet_id</span>
</span></span><span style=display:flex><span>  idle_timeout       <span style=color:#f92672>=</span> <span style=color:#ae81ff>3600</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  enable_deletion_protection <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_alb_target_group&#34; &#34;this&#34;</span> {
</span></span><span style=display:flex><span>  name        <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>service_name</span>
</span></span><span style=display:flex><span>  port        <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>  protocol    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;HTTP&#34;</span>
</span></span><span style=display:flex><span>  vpc_id      <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>vpc_id</span>
</span></span><span style=display:flex><span>  target_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ip&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>health_check</span> {
</span></span><span style=display:flex><span>    healthy_threshold   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span>    interval            <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;30&#34;</span>
</span></span><span style=display:flex><span>    protocol            <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;HTTP&#34;</span>
</span></span><span style=display:flex><span>    matcher             <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;200&#34;</span>
</span></span><span style=display:flex><span>    timeout             <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span>    path                <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>health_check_path</span>
</span></span><span style=display:flex><span>    unhealthy_threshold <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;2&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_alb_listener&#34; &#34;http&#34;</span> {
</span></span><span style=display:flex><span>  load_balancer_arn <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_lb</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  port              <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>  protocol          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;HTTP&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>default_action</span> {
</span></span><span style=display:flex><span>    type             <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;forward&#34;</span>
</span></span><span style=display:flex><span>    target_group_arn <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_alb_target_group</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>arn</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_alb_listener&#34; &#34;https&#34;</span> {
</span></span><span style=display:flex><span>  load_balancer_arn <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_lb</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  port              <span style=color:#f92672>=</span> <span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>  protocol          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;HTTPS&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ssl_policy      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ELBSecurityPolicy-2016-08&#34;</span>
</span></span><span style=display:flex><span>  certificate_arn <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_acm_certificate</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>arn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>default_action</span> {
</span></span><span style=display:flex><span>    target_group_arn <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_alb_target_group</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>    type             <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;forward&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=autoscaling>Autoscaling<a hidden class=anchor aria-hidden=true href=#autoscaling>#</a></h2><p>Because we are using cloud, and I love taking advantage of dynamic resources allocation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_appautoscaling_target&#34; &#34;this&#34;</span> {
</span></span><span style=display:flex><span>  max_capacity       <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  min_capacity       <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  resource_id        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;service/${var.ecs_cluster_name}/${aws_ecs_service.this.name}&#34;</span>
</span></span><span style=display:flex><span>  scalable_dimension <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ecs:service:DesiredCount&#34;</span>
</span></span><span style=display:flex><span>  service_namespace  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ecs&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_appautoscaling_policy&#34; &#34;memory&#34;</span> {
</span></span><span style=display:flex><span>  name               <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;memory-autoscaling&#34;</span>
</span></span><span style=display:flex><span>  policy_type        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TargetTrackingScaling&#34;</span>
</span></span><span style=display:flex><span>  resource_id        <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_appautoscaling_target</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>resource_id</span>
</span></span><span style=display:flex><span>  scalable_dimension <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_appautoscaling_target</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>scalable_dimension</span>
</span></span><span style=display:flex><span>  service_namespace  <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_appautoscaling_target</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>service_namespace</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>target_tracking_scaling_policy_configuration</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>predefined_metric_specification</span> {
</span></span><span style=display:flex><span>      predefined_metric_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ECSServiceAverageMemoryUtilization&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    target_value <span style=color:#f92672>=</span> <span style=color:#ae81ff>40</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_appautoscaling_policy&#34; &#34;cpu&#34;</span> {
</span></span><span style=display:flex><span>  name               <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cpu-autoscaling&#34;</span>
</span></span><span style=display:flex><span>  policy_type        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TargetTrackingScaling&#34;</span>
</span></span><span style=display:flex><span>  resource_id        <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_appautoscaling_target</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>resource_id</span>
</span></span><span style=display:flex><span>  scalable_dimension <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_appautoscaling_target</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>scalable_dimension</span>
</span></span><span style=display:flex><span>  service_namespace  <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_appautoscaling_target</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>service_namespace</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>target_tracking_scaling_policy_configuration</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>predefined_metric_specification</span> {
</span></span><span style=display:flex><span>      predefined_metric_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ECSServiceAverageCPUUtilization&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    target_value <span style=color:#f92672>=</span> <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.karnwong.me/tags/devops/>devops</a></li><li><a href=https://www.karnwong.me/tags/terraform/>terraform</a></li><li><a href=https://www.karnwong.me/tags/aws/>aws</a></li></ul><nav class=paginav><a class=prev href=https://www.karnwong.me/posts/2022/09/intro-to-pulumi/><span class=title>¬´ Prev</span><br><span>Intro to Pulumi</span></a>
<a class=next href=https://www.karnwong.me/posts/2022/08/data-engineer-archtypes/><span class=title>Next ¬ª</span><br><span>Data engineer archtypes</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://www.karnwong.me/>Karn Wong</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>