<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Terraform with ECS task on EC2 backend | Karn Wong</title><meta name=keywords content="devops,terraform,aws"><meta name=description content="Previously I wrote about setting up ECS task on fargate backend. But we can also use EC2 as backend too, in some cases where the workload is consistent, ie scaling is not required, since EC2 would be cheaper than fargate backend, even more so if you have reserved instance on top. There&rsquo;s a few modifications from the fargate version to make it work with EC2 backend, if you are curious you can try to hunt those down ðŸ˜Ž."><meta name=author content="Karn Wong"><link rel=canonical href=https://www.karnwong.me/posts/2022/10/terraform-with-ecs-task-on-ec2-backend/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.karnwong.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.karnwong.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.karnwong.me/favicon-32x32.png><link rel=apple-touch-icon href=https://www.karnwong.me/apple-touch-icon.png><link rel=mask-icon href=https://www.karnwong.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-8CYMFC0KZ9"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8CYMFC0KZ9",{anonymize_ip:!1})}</script><meta property="og:title" content="Terraform with ECS task on EC2 backend"><meta property="og:description" content="Previously I wrote about setting up ECS task on fargate backend. But we can also use EC2 as backend too, in some cases where the workload is consistent, ie scaling is not required, since EC2 would be cheaper than fargate backend, even more so if you have reserved instance on top. There&rsquo;s a few modifications from the fargate version to make it work with EC2 backend, if you are curious you can try to hunt those down ðŸ˜Ž."><meta property="og:type" content="article"><meta property="og:url" content="https://www.karnwong.me/posts/2022/10/terraform-with-ecs-task-on-ec2-backend/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-04T22:04:34+07:00"><meta property="article:modified_time" content="2022-10-04T22:04:34+07:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Terraform with ECS task on EC2 backend"><meta name=twitter:description content="Previously I wrote about setting up ECS task on fargate backend. But we can also use EC2 as backend too, in some cases where the workload is consistent, ie scaling is not required, since EC2 would be cheaper than fargate backend, even more so if you have reserved instance on top. There&rsquo;s a few modifications from the fargate version to make it work with EC2 backend, if you are curious you can try to hunt those down ðŸ˜Ž."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.karnwong.me/posts/"},{"@type":"ListItem","position":2,"name":"Terraform with ECS task on EC2 backend","item":"https://www.karnwong.me/posts/2022/10/terraform-with-ecs-task-on-ec2-backend/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Terraform with ECS task on EC2 backend","name":"Terraform with ECS task on EC2 backend","description":"Previously I wrote about setting up ECS task on fargate backend. But we can also use EC2 as backend too, in some cases where the workload is consistent, ie scaling is not required, since EC2 would be cheaper than fargate backend, even more so if you have reserved instance on top. There\u0026rsquo;s a few modifications from the fargate version to make it work with EC2 backend, if you are curious you can try to hunt those down ðŸ˜Ž.","keywords":["devops","terraform","aws"],"articleBody":"Previously I wrote about setting up ECS task on fargate backend. But we can also use EC2 as backend too, in some cases where the workload is consistent, ie scaling is not required, since EC2 would be cheaper than fargate backend, even more so if you have reserved instance on top. Thereâ€™s a few modifications from the fargate version to make it work with EC2 backend, if you are curious you can try to hunt those down ðŸ˜Ž. Repo here.\nTask definition #tfsec:ignore:aws-cloudwatch-log-group-customer-key resource \"aws_cloudwatch_log_group\" \"this\" { retention_in_days = 14 name = \"/aws/ecs/${var.service_name}\" } resource \"aws_ecs_task_definition\" \"this\" { family = var.service_name cpu = var.cpu memory = var.memory execution_role_arn = var.task_role task_role_arn = var.task_role container_definitions = jsonencode( [ { name = var.service_name image = var.image_uri essential = true environment = [] portMappings = [ { protocol = \"tcp\" containerPort = 80 hostPort = 80 } ] logConfiguration = { logDriver = \"awslogs\" options = { awslogs-group = aws_cloudwatch_log_group.this.name awslogs-region = var.aws_region awslogs-stream-prefix = \"ecs\" } } } ] ) } resource \"aws_ecs_service\" \"this\" { name = var.service_name cluster = var.ecs_cluster_id task_definition = aws_ecs_task_definition.this.arn desired_count = 1 # https://github.com/hashicorp/terraform/issues/26950 depends_on = [aws_lb.this, aws_alb_target_group.this] ordered_placement_strategy { type = \"spread\" field = \"instanceId\" } load_balancer { target_group_arn = aws_alb_target_group.this.arn container_name = var.service_name container_port = 80 } } SSL certificate resource \"aws_acm_certificate\" \"this\" { domain_name = var.domain_name validation_method = \"DNS\" lifecycle { create_before_destroy = true } tags = { Name = var.domain_name } } Load balancer #tfsec:ignore:aws-elb-alb-not-public #tfsec:ignore:aws-elb-drop-invalid-headers resource \"aws_lb\" \"this\" { name = var.service_name internal = false load_balancer_type = \"application\" security_groups = [var.alb_id] subnets = var.subnet_id } resource \"aws_alb_target_group\" \"this\" { name = var.service_name port = 80 protocol = \"HTTP\" vpc_id = var.vpc_id target_type = \"instance\" health_check { port = \"traffic-port\" path = var.health_check_path matcher = \"200-499\" } } #tfsec:ignore:aws-elb-http-not-used resource \"aws_alb_listener\" \"http\" { load_balancer_arn = aws_lb.this.id port = 80 protocol = \"HTTP\" default_action { type = \"redirect\" redirect { port = \"443\" protocol = \"HTTPS\" status_code = \"HTTP_301\" } } } #tfsec:ignore:aws-elb-use-secure-tls-policy resource \"aws_alb_listener\" \"https\" { load_balancer_arn = aws_lb.this.id port = 443 protocol = \"HTTPS\" ssl_policy = \"ELBSecurityPolicy-2016-08\" certificate_arn = aws_acm_certificate.this.arn default_action { type = \"forward\" target_group_arn = aws_alb_target_group.this.id } } ","wordCount":"358","inLanguage":"en","datePublished":"2022-10-04T22:04:34+07:00","dateModified":"2022-10-04T22:04:34+07:00","author":{"@type":"Person","name":"Karn Wong"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.karnwong.me/posts/2022/10/terraform-with-ecs-task-on-ec2-backend/"},"publisher":{"@type":"Organization","name":"Karn Wong","logo":{"@type":"ImageObject","url":"https://www.karnwong.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.karnwong.me/ accesskey=h title="Karn Wong (Alt + H)">Karn Wong</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.karnwong.me/about/ title=About><span>About</span></a></li><li><a href=https://www.karnwong.me/posts title=Posts><span>Posts</span></a></li><li><a href=https://www.karnwong.me/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://www.karnwong.me/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://www.karnwong.me/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.karnwong.me/>Home</a>&nbsp;Â»&nbsp;<a href=https://www.karnwong.me/posts/>Posts</a></div><h1 class=post-title>Terraform with ECS task on EC2 backend</h1><div class=post-meta><span title='2022-10-04 22:04:34 +0700 +07'>October 4, 2022</span>&nbsp;Â·&nbsp;2 min&nbsp;Â·&nbsp;Karn Wong</div></header><div class=post-content><p><a href=https://www.karnwong.me/posts/2022/08/minimal-ecs-task-with-fargate-backend/>Previously</a> I wrote about setting up ECS task on fargate backend. But we can also use EC2 as backend too, in some cases where the workload is consistent, ie scaling is not required, since EC2 would be cheaper than fargate backend, even more so if you have reserved instance on top. There&rsquo;s a few modifications from the fargate version to make it work with EC2 backend, if you are curious you can try to hunt those down ðŸ˜Ž. Repo <a href=https://github.com/devbaygroup/terraform-aws-ecs-ec2-example>here</a>.</p><h2 id=task-definition>Task definition<a hidden class=anchor aria-hidden=true href=#task-definition>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e>#tfsec:ignore:aws-cloudwatch-log-group-customer-key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_cloudwatch_log_group&#34; &#34;this&#34;</span> {
</span></span><span style=display:flex><span>  retention_in_days <span style=color:#f92672>=</span> <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>  name              <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/aws/ecs/${var.service_name}&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_ecs_task_definition&#34; &#34;this&#34;</span> {
</span></span><span style=display:flex><span>  family             <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>service_name</span>
</span></span><span style=display:flex><span>  cpu                <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>cpu</span>
</span></span><span style=display:flex><span>  memory             <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>memory</span>
</span></span><span style=display:flex><span>  execution_role_arn <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>task_role</span>
</span></span><span style=display:flex><span>  task_role_arn      <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>task_role</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  container_definitions <span style=color:#f92672>=</span> <span style=color:#66d9ef>jsonencode</span>(
</span></span><span style=display:flex><span>    [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        name        <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>service_name</span>
</span></span><span style=display:flex><span>        image       <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>image_uri</span>
</span></span><span style=display:flex><span>        essential   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        environment <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        portMappings <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            protocol      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tcp&#34;</span>
</span></span><span style=display:flex><span>            containerPort <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>            hostPort      <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>        logConfiguration <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>          logDriver <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;awslogs&#34;</span>
</span></span><span style=display:flex><span>          options <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            awslogs-group         <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_cloudwatch_log_group</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>            awslogs-region        <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>aws_region</span>
</span></span><span style=display:flex><span>            awslogs-stream-prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ecs&#34;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_ecs_service&#34; &#34;this&#34;</span> {
</span></span><span style=display:flex><span>  name            <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>service_name</span>
</span></span><span style=display:flex><span>  cluster         <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>ecs_cluster_id</span>
</span></span><span style=display:flex><span>  task_definition <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_ecs_task_definition</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>arn</span>
</span></span><span style=display:flex><span>  desired_count   <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # https://github.com/hashicorp/terraform/issues/26950
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  depends_on <span style=color:#f92672>=</span> [<span style=color:#66d9ef>aws_lb</span>.<span style=color:#66d9ef>this</span>, <span style=color:#66d9ef>aws_alb_target_group</span>.<span style=color:#66d9ef>this</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>ordered_placement_strategy</span> {
</span></span><span style=display:flex><span>    type  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;spread&#34;</span>
</span></span><span style=display:flex><span>    field <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;instanceId&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>load_balancer</span> {
</span></span><span style=display:flex><span>    target_group_arn <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_alb_target_group</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>arn</span>
</span></span><span style=display:flex><span>    container_name   <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>service_name</span>
</span></span><span style=display:flex><span>    container_port   <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=ssl-certificate>SSL certificate<a hidden class=anchor aria-hidden=true href=#ssl-certificate>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_acm_certificate&#34; &#34;this&#34;</span> {
</span></span><span style=display:flex><span>  domain_name       <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>domain_name</span>
</span></span><span style=display:flex><span>  validation_method <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;DNS&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>lifecycle</span> {
</span></span><span style=display:flex><span>    create_before_destroy <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    Name <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>domain_name</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=load-balancer>Load balancer<a hidden class=anchor aria-hidden=true href=#load-balancer>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#75715e>#tfsec:ignore:aws-elb-alb-not-public
</span></span></span><span style=display:flex><span><span style=color:#75715e>#tfsec:ignore:aws-elb-drop-invalid-headers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_lb&#34; &#34;this&#34;</span> {
</span></span><span style=display:flex><span>  name               <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>service_name</span>
</span></span><span style=display:flex><span>  internal           <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  load_balancer_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;application&#34;</span>
</span></span><span style=display:flex><span>  security_groups    <span style=color:#f92672>=</span> [<span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>alb_id</span>]
</span></span><span style=display:flex><span>  subnets            <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>subnet_id</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_alb_target_group&#34; &#34;this&#34;</span> {
</span></span><span style=display:flex><span>  name        <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>service_name</span>
</span></span><span style=display:flex><span>  port        <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>  protocol    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;HTTP&#34;</span>
</span></span><span style=display:flex><span>  vpc_id      <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>vpc_id</span>
</span></span><span style=display:flex><span>  target_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;instance&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>health_check</span> {
</span></span><span style=display:flex><span>    port    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;traffic-port&#34;</span>
</span></span><span style=display:flex><span>    path    <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>health_check_path</span>
</span></span><span style=display:flex><span>    matcher <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;200-499&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#tfsec:ignore:aws-elb-http-not-used
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_alb_listener&#34; &#34;http&#34;</span> {
</span></span><span style=display:flex><span>  load_balancer_arn <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_lb</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  port              <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>  protocol          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;HTTP&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>default_action</span> {
</span></span><span style=display:flex><span>    type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;redirect&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>redirect</span> {
</span></span><span style=display:flex><span>      port        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;443&#34;</span>
</span></span><span style=display:flex><span>      protocol    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;HTTPS&#34;</span>
</span></span><span style=display:flex><span>      status_code <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;HTTP_301&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#tfsec:ignore:aws-elb-use-secure-tls-policy
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_alb_listener&#34; &#34;https&#34;</span> {
</span></span><span style=display:flex><span>  load_balancer_arn <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_lb</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  port              <span style=color:#f92672>=</span> <span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>  protocol          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;HTTPS&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ssl_policy      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ELBSecurityPolicy-2016-08&#34;</span>
</span></span><span style=display:flex><span>  certificate_arn <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_acm_certificate</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>arn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>default_action</span> {
</span></span><span style=display:flex><span>    type             <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;forward&#34;</span>
</span></span><span style=display:flex><span>    target_group_arn <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_alb_target_group</span>.<span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.karnwong.me/tags/devops/>devops</a></li><li><a href=https://www.karnwong.me/tags/terraform/>terraform</a></li><li><a href=https://www.karnwong.me/tags/aws/>aws</a></li></ul><nav class=paginav><a class=prev href=https://www.karnwong.me/posts/2022/10/deploy-static-site-with-branch-preview-via-cloudflare-pages/><span class=title>Â« Prev</span><br><span>Deploy static site with branch preview via Cloudflare Pages</span></a>
<a class=next href=https://www.karnwong.me/posts/2022/09/intro-to-dagster-cloud/><span class=title>Next Â»</span><br><span>Intro to Dagster Cloud</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://www.karnwong.me/>Karn Wong</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>